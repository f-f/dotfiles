#!/bin/bash

set -e -o pipefail

echo "Starting bootstrap!"

# Create some folders
echo "Creating some useful folders..."
mkdir -p ~/.fonts
mkdir -p ~/.gnupg
mkdir -p ~/.lein
mkdir -p ~/.tmp
mkdir -p ~/.ssh
mkdir -p ~/code

echo "Installing packages..."
./install

echo "Creating dotfiles links in ~..."
./make-links

# Setup mta
echo "Setting up SMTP MTA..."
echo "root: fabrizio@ferrai.io" >> /etc/aliases && newaliases

# Decrypt stuff
echo "Decrypting all the things..."
gpg2 --no-tty -q -d ~/dotfiles/mail/msmtp-password.gpg > ~/.tmp/mailpass
gpg2 --no-tty -q -d ~/dotfiles/cryptd/pushbullet-token.gpg > ~/.tmp/pb-token
gpg2 --no-tty -q -d ~/dotfiles/cryptd/idea15.jar.gpg > ~/.tmp/idea15.jar
./bin/decrypt-fonts

# Install cronjobs
echo "Installing systemd timers..."
for FILE in ~/dotfiles/systemd/*.timer; do
  sudo systemctl enable $(basename $FILE)
  sudo systemctl start $(basename $FILE)
done
sudo systemctl daemon-reload

echo "Done!"
